{{ define "main" }}
<article>
  <h1>ğŸ‘¤ {{ .Title }}</h1>

  <div class="metadata">
    {{ if or .Params.birth .Params.death .Params.roles }}
      {{ if .Params.birth }}<p><strong>ğŸ“… Born:</strong> {{ .Params.birth }}</p>{{ end }}
      {{ if .Params.death }}<p><strong>âš°ï¸ Died:</strong> {{ .Params.death }}</p>{{ end }}
      {{ if .Params.roles }}<p><strong>ğŸ’¼ Roles:</strong> {{ delimit .Params.roles ", " }}</p>{{ end }}
    {{ end }}
    
    {{ with .Params.aliases }}
      <p><strong>Also known as:</strong> <em>{{ delimit . ", " }}</em></p>
    {{ end }}
    
    {{ with .Params.notes }}
      <p style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5ddd3;"><strong>â„¹ï¸ Notes:</strong> {{ . }}</p>
    {{ end }}
  </div>

  <div class="content-section">
    {{ .Content }}
  </div>

  <hr>

  <div class="content-section">
    <h2>ğŸ“œ Historical Records</h2>
    <p style="font-style: italic; color: #7d6c5a; margin-bottom: 1rem;">Records mentioning {{ .Title }}</p>
    
    {{/* Resident ID from file path */}}
    {{ $dir := trim .File.Dir "/" }}
    {{ $personID := cond (eq $dir "") .File.BaseFileName (printf "%s/%s" $dir .File.BaseFileName) }}

    {{/* All regular pages except residents/buildings/institutions */}}
    {{ $pages := site.RegularPages }}
    {{ $pages = where $pages "Section" "ne" "resident" }}
    {{ $pages = where $pages "Section" "ne" "building" }}
    {{ $pages = where $pages "Section" "ne" "institution" }}

    {{ $foundRecords := false }}
    {{ $relatedBuildings := slice }}
    {{ $relatedInstitutions := slice }}
    {{ $announcements := slice }}
    {{ $regularRecords := slice }}
    
    {{/* Separate announcements from regular records */}}
    {{ range sort (where $pages "Params.residents" "intersect" (slice $personID)) "Date" }}
      {{ if eq .Params.record_type "announcement" }}
        {{ $announcements = $announcements | append . }}
      {{ else }}
        {{ $regularRecords = $regularRecords | append . }}
      {{ end }}
      
      {{/* ONLY collect buildings from person_building_links for this resident */}}
      {{ if .Params.person_building_links }}
        {{ range $resident, $buildings := .Params.person_building_links }}
          {{ if eq $resident $personID }}
            {{ range $buildings }}
              {{ $relatedBuildings = $relatedBuildings | append . }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
      
      {{/* ONLY collect institutions from person_institution_links for this resident */}}
      {{ if .Params.person_institution_links }}
        {{ range $resident, $institutions := .Params.person_institution_links }}
          {{ if eq $resident $personID }}
            {{ range $institutions }}
              {{ $relatedInstitutions = $relatedInstitutions | append . }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
    
    <ul>
      {{ range $regularRecords }}
        {{ $foundRecords = true }}
        <li style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f9f7f4; border-left: 3px solid #8b7355; border-radius: 4px;">
          <a href="{{ .RelPermalink }}" style="border: none; font-weight: bold;">{{ .Title }}</a>
          {{ with .Date }}<br><span class="date">{{ .Format "2 January 2006" }}</span>{{ end }}
        </li>
      {{ end }}
    </ul>
    
    {{ if not $foundRecords }}
      <p style="font-style: italic; color: #999;">No records found yet.</p>
    {{ end }}
  </div>

  {{/* Announcements Section */}}
  {{ if gt (len $announcements) 0 }}
  <hr>
  
  <div class="content-section">
    <h2>ğŸ“° Announcements</h2>
    <p style="font-style: italic; color: #7d6c5a; margin-bottom: 1rem;">Birth, marriage, and death announcements</p>
    
    <ul>
      {{ range $announcements }}
        <li style="padding: 0.5rem; margin-bottom: 0.5rem; background: #fefdfb; border-left: 2px solid #bfa88f; border-radius: 4px;">
          {{ if .Params.announcement_type }}
            <span style="display: inline-block; padding: 0.1rem 0.4rem; background: #8b7355; color: white; font-size: 0.75rem; border-radius: 3px; margin-right: 0.5rem;">{{ .Params.announcement_type | upper }}</span>
          {{ end }}
          <a href="{{ .RelPermalink }}" style="border: none;">{{ .Title }}</a>
          {{ with .Date }}<br><span class="date" style="font-size: 0.85rem;">{{ .Format "2 January 2006" }}</span>{{ end }}
        </li>
      {{ end }}
    </ul>
  </div>
  {{ end }}

  {{/* Census Appearances */}}
  {{ $censusAppearances := slice }}
  {{ range where site.RegularPages "Section" "census" }}
    {{ $censusPage := . }}
    {{ range $entryIndex, $entry := .Params.entries }}
      {{ range $personIndex, $person := $entry.household }}
        {{ if and $person.resident (eq $person.resident $personID) }}
          {{ $censusAppearances = $censusAppearances | append (dict "census" $censusPage "entry" $entry "person" $person "personIndex" $personIndex) }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ if $censusAppearances }}
  <hr>
  
  <div class="content-section">
    <h2>ğŸ“Š Census Appearances</h2>
    <p style="font-style: italic; color: #7d6c5a; margin-bottom: 1rem;">Census records mentioning {{ .Title }}</p>
    
    <ul>
      {{ range $censusAppearances }}
        <li style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f9f7f4; border-left: 3px solid #6b8e23; border-radius: 4px;">
          <a href="{{ .census.RelPermalink }}#schedule-{{ .entry.schedule }}-person-{{ .personIndex }}" style="border: none; font-weight: bold;">
            {{ .census.Title }}
          </a>
          <br><span class="date">{{ .census.Params.census_date }}</span>
          {{ if .entry.street }}<br><small style="color: #7d6c5a;">{{ .entry.street }}{{ if .entry.address }}, {{ .entry.address }}{{ end }}</small>{{ end }}
          <br><small style="color: #7d6c5a;">
            <strong>{{ .person.relation }}</strong>
            {{ if .person.age }} | Age: {{ .person.age }}{{ end }}
            {{ if .person.occupation }} | {{ .person.occupation }}{{ end }}
          </small>
        </li>
      {{ end }}
    </ul>
  </div>
  {{ end }}

  {{/* Show derived buildings and institutions */}}
  {{ if or $relatedBuildings $relatedInstitutions }}
  <hr>
  
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; margin: 2rem 0;">
    
    {{ if $relatedBuildings }}
    <div class="content-section">
      <h2>ğŸ›ï¸ Associated Buildings</h2>
      <p style="font-style: italic; color: #7d6c5a; font-size: 0.9rem;">Derived from historical records</p>
      <ul>
        {{ range ($relatedBuildings | uniq) }}
          {{ with site.GetPage . }}
            <li>
              <a href="{{ .RelPermalink }}">{{ .Title }}</a>
              {{ with .Params.street }}<br><small style="color: #7d6c5a;">{{ . }}</small>{{ end }}
            </li>
          {{ end }}
        {{ end }}
      </ul>
    </div>
    {{ end }}

    {{ if $relatedInstitutions }}
    <div class="content-section">
      <h2>ğŸ¢ Associated Institutions</h2>
      <p style="font-style: italic; color: #7d6c5a; font-size: 0.9rem;">Derived from historical records</p>
      <ul>
        {{ range ($relatedInstitutions | uniq) }}
          {{ with site.GetPage . }}
            <li>
              <a href="{{ .RelPermalink }}">{{ .Title }}</a>
              {{ with .Params.institution_type }}<br><small style="color: #7d6c5a;">({{ . | title }})</small>{{ end }}
            </li>
          {{ end }}
        {{ end }}
      </ul>
    </div>
    {{ end }}
    
  </div>
  {{ end }}
</article>
{{ end }}
